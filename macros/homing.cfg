# Homing Override Helper Macros
# Hardware-agnostic homing utilities with edge clearance and variable current
# Part of klipper-nerdygriffin-macros
#
# References: https://docs.beacon3d.com/contact/#82-homing-override

[gcode_macro _HOME_VARS]
variable_home_current: 0.7
gcode: # Gcode section left intentionally blank. Do not disturb.
    {action_respond_info(" Running the _HOME_VARS macro does nothing, it is only used for storing HOME settings. ")}

[gcode_macro _HOME_EDGE_CLEARANCE]
gcode:
    {% set edge_margin = 20 %}
    {% set homing_retract_speed = (printer.configfile.settings.stepper_x.homing_retract_speed|int * 60)|int %}
    {% set x_safe = [([printer.toolhead.position.x, printer.toolhead.axis_minimum.x + edge_margin]|max), printer.toolhead.axis_maximum.x - edge_margin]|min %}
    {% set y_safe = [([printer.toolhead.position.y, printer.toolhead.axis_minimum.y + edge_margin]|max), printer.toolhead.axis_maximum.y - edge_margin]|min %}
    {% if "xy" in printer.toolhead.homed_axes %}
        SAVE_GCODE_STATE NAME=home_edge_clearance
        G90
        G0 X{x_safe} Y{y_safe} F{homing_retract_speed}
        RESTORE_GCODE_STATE NAME=home_edge_clearance

    {% elif "x" in printer.toolhead.homed_axes %}
        # Only X homed: move X to safe, Y stays unhomed
        SAVE_GCODE_STATE NAME=home_edge_clearance
        G90
        G0 X{x_safe} F{homing_retract_speed}
        RESTORE_GCODE_STATE NAME=home_edge_clearance

    {% elif "y" in printer.toolhead.homed_axes %}
        # Only Y homed: move Y to safe, X stays unhomed
        SAVE_GCODE_STATE NAME=home_edge_clearance
        G90
        G0 Y{y_safe} F{homing_retract_speed}
        RESTORE_GCODE_STATE NAME=home_edge_clearance

    {% else %}
        {% set force_move_velocity = printer.configfile.settings.stepper_x.homing_retract_speed|int %}
        {% set force_move_accel = (printer.configfile.settings.printer.max_accel / 10)|int %}
        # Use FORCE_MOVE to shift away from potential edges
        # This allows movement without homing, bypassing all kinematic validation
        FORCE_MOVE STEPPER=stepper_x DISTANCE={(edge_margin)|int} VELOCITY={force_move_velocity} ACCEL={force_move_accel}
        FORCE_MOVE STEPPER=stepper_y DISTANCE={(edge_margin)|int} VELOCITY={force_move_velocity} ACCEL={force_move_accel}
        FORCE_MOVE STEPPER=stepper_x DISTANCE={(-edge_margin*2)|int} VELOCITY={force_move_velocity} ACCEL={force_move_accel}
        FORCE_MOVE STEPPER=stepper_y DISTANCE={(-edge_margin*2)|int} VELOCITY={force_move_velocity} ACCEL={force_move_accel}
        FORCE_MOVE STEPPER=stepper_x DISTANCE={(edge_margin)|int} VELOCITY={force_move_velocity} ACCEL={force_move_accel}
        FORCE_MOVE STEPPER=stepper_y DISTANCE={(edge_margin)|int} VELOCITY={force_move_velocity} ACCEL={force_move_accel}
        # FORCE_MOVE STEPPER=stepper_x DISTANCE={(-edge_margin)|int} VELOCITY={force_move_velocity} ACCEL=3000
        G4 P200
    {% endif %}

[gcode_macro _HOME_PRE_AXIS]
variable_home_current: 0.7
gcode:
    {% set axis = params.AXIS|lower %}
    STATUS_HOMING
    {% if printer['gcode_macro NW_RETRACT'] is defined %}
        NW_RETRACT
    {% endif %}
    SET_VELOCITY_LIMIT ACCEL=3000

    {% if "x" in axis %}
        SET_GCODE_VARIABLE MACRO=_HOME_POST_AXIS VARIABLE=fan_speed_before_homing VALUE={printer.fan.speed * 255}
        M106 S0
    {% endif %}

    {% if "z" not in axis %}
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={home_current}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={home_current}
        G4 P200
    {% endif %}

    _HOME_EDGE_CLEARANCE

    # Make sure StallGuard registers are cleared
    M400

[gcode_macro _HOME_POST_AXIS]
variable_fan_speed_before_homing: 0
gcode:
    {% set axis = params.AXIS|lower %}
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}

    {% if "z" not in axis %}
        # Move away
        SAVE_GCODE_STATE NAME=home_post_axis
        G91
        G0 {axis}-10 F{(printer.configfile.settings.stepper_x.homing_retract_speed|int * 60)|int}
        RESTORE_GCODE_STATE NAME=home_post_axis
    {% endif %}

    # Make sure StallGuard registers are cleared
    M400

    {% if "z" not in axis %}
        # Set current during print
        SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
        SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
        G4 P200
    {% endif %}

    {% if "x" in axis %}
        M106 S{fan_speed_before_homing}
    {% endif %}

    # Restore configure acceleration
    SET_VELOCITY_LIMIT ACCEL={printer.configfile.settings.printer.max_accel} SQUARE_CORNER_VELOCITY={printer.configfile.settings.printer.square_corner_velocity}
    G0 F{travel_speed}
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=1


[gcode_macro _CG28]
description: Homing only if necessary
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

[gcode_macro TEST_SENSORLESS_HOME_X]
gcode:
    {% set TEST_SGTHRS = params.TEST_SGTHRS|default(255)|int %}
    SET_TMC_FIELD STEPPER=stepper_x FIELD=SGTHRS VALUE={TEST_SGTHRS}
    AUTOTUNE_TMC STEPPER=stepper_x SG4_THRS={TEST_SGTHRS}
    M117 X Sensitivity: {TEST_SGTHRS}
    G4 P1000
    G28 X0
    G4 P1000
    M84

[gcode_macro TEST_SENSORLESS_HOME_Y]
gcode:
    {% set TEST_SGTHRS = params.TEST_SGTHRS|default(255)|int %}
    SET_TMC_FIELD STEPPER=stepper_y FIELD=SGTHRS VALUE={TEST_SGTHRS}
    AUTOTUNE_TMC STEPPER=stepper_y SG4_THRS={TEST_SGTHRS}
    M117 Y Sensitivity: {TEST_SGTHRS}
    G4 P1000
    G28 Y0
    G4 P1000
    M84

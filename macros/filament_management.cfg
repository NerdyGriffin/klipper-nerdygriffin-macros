# Filament loading, unloading, and purging operations
# Hardware-agnostic implementation with AFC support
# Part of klipper-nerdygriffin-macros

#####################################################################
#   Helper Macros (Internal Use)
#####################################################################

[gcode_macro _FILAMENT_OPERATION_INIT]
description: Common initialization for filament operations
gcode:
    {% set motion_sensor_enabled = printer["filament_motion_sensor encoder_sensor"].enabled %}
    M300 P200
    SAVE_GCODE_STATE NAME=filament_operation_state
    SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0
    # Store sensor state for cleanup
    SET_GCODE_VARIABLE MACRO=_FILAMENT_OPERATION_CLEANUP VARIABLE=restore_sensor VALUE={motion_sensor_enabled}

[gcode_macro _FILAMENT_OPERATION_CLEANUP]
description: Common cleanup for filament operations
variable_restore_sensor: False
gcode:
    {% set is_paused = printer.pause_resume.is_paused or printer.virtual_sdcard.is_active %}
    M400                           ; wait for moves to finish
    M104 S150
    {% if printer['gcode_macro AFC_PARK'] is defined %}
        AFC_PARK
    {% else %}
        _TOOLHEAD_PARK_LOAD_UNLOAD
    {% endif %}
    M400                           ; wait for moves to finish
    RESET_STATUS
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=10
    {% if restore_sensor %}
        SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1
    {% endif %}
    M300 P400 # long beep
    RESTORE_GCODE_STATE NAME=filament_operation_state
    {% if is_paused %} SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=True {% endif %}

[gcode_macro _HEAT_AND_PARK]
description: Heat extruder and park for filament operation
gcode:
    {% set extruder_temp = params.TEMP|int %}
    {% set park_macro = params.PARK_MACRO|default("_TOOLHEAD_PARK_LOAD_UNLOAD")|string %}
    M104 S{extruder_temp}
    {park_macro}
    M109 S{extruder_temp}          ; set extruder temperature and wait until it reaches target
    M400                           ; wait for buffer to clear
    STATUS_BUSY

#####################################################################
#   Toolhead Parking Positions (Hardware Agnostic)
#####################################################################

[gcode_macro _FILAMENT_PARK_PARAMS]
description: Configurable parking positions for filament operations
# Override these in your printer.cfg to customize parking positions
variable_load_x: None          # X position for load/unload (None = auto-calculate center)
variable_load_y: None          # Y position for load/unload (None = auto-calculate front + 10mm)
variable_purge_x: None         # X position for purge (None = 10mm)
variable_purge_y: None         # Y position for purge (None = auto-calculate front + 10mm)
gcode:

[gcode_macro _TOOLHEAD_PARK_LOAD_UNLOAD]
description: Park toolhead for filament load/unload operations
gcode:
    ##### get config and toolhead values #####
    {% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
    {% set params = printer['gcode_macro _FILAMENT_PARK_PARAMS'] %}

    {% if params.load_x is not none and params.load_y is not none %}
        ##### Use user-configured positions (highest priority) #####
        {% set x_park = params.load_x|float %}
        {% set y_park = params.load_y|float %}
    {% elif printer['gcode_macro _AFC_BRUSH_VARS'] is defined %}
        ##### Use AFC brush location #####
        {% set vars = printer['gcode_macro _AFC_BRUSH_VARS'] %}
        {% set Bx, By, Bz = vars.brush_loc | default([-1,-1,-1])| map('float') %}
        {% set brush_width = vars['brush_width'] | default(30) | float %}
        {% set x_park = Bx + brush_width %}
        {% set y_park = By %}
    {% else %}
        ##### Fallback: auto-calculate based on bed size #####
        {% set x_park = printer.toolhead.axis_maximum.x|float / 2.0 %}
        {% set y_park = printer.toolhead.axis_minimum.y|float + 10 %}
    {% endif %}

    ##### end of definitions #####
    {% if not (printer.pause_resume.is_paused or printer.virtual_sdcard.is_active) %}
        _TOOLHEAD_PARK_Z
    {% endif %}
    G90
    G0 X{x_park} Y{y_park} F{travel_speed}

[gcode_macro _TOOLHEAD_PARK_PURGE]
description: Park toolhead for filament purge operations
gcode:
    ##### get config and toolhead values #####
    {% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
    {% set params = printer['gcode_macro _FILAMENT_PARK_PARAMS'] %}

    {% if params.purge_x is not none and params.purge_y is not none %}
        ##### Use user-configured positions (highest priority) #####
        {% set x_park = params.purge_x|float %}
        {% set y_park = params.purge_y|float %}
    {% elif printer['gcode_macro _AFC_BRUSH_VARS'] is defined %}
        ##### Use AFC brush location #####
        {% set vars = printer['gcode_macro _AFC_BRUSH_VARS'] %}
        {% set Bx, By, Bz = vars.brush_loc | default([-1,-1,-1])| map('float') %}
        {% set brush_width = vars['brush_width'] | default(30) | float %}
        {% set x_park = Bx + brush_width %}
        {% set y_park = By %}
    {% else %}
        ##### Fallback: use default purge position #####
        {% set x_park = 10 %}
        {% set y_park = printer.toolhead.axis_minimum.y|float + 10 %}
    {% endif %}

    ##### end of definitions #####
    {% if not (printer.pause_resume.is_paused or printer.virtual_sdcard.is_active) %}
        _TOOLHEAD_PARK_Z
    {% endif %}
    G90
    G0 X{x_park} Y{y_park} F{travel_speed}

[gcode_macro _TOOLHEAD_PARK_Z]
description: Park toolhead at safe Z height
gcode:
    ##### get config and toolhead values #####
    {% set extruder_temp = printer.extruder.target|int %}
    {% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}
    {% set z_max = printer.toolhead.axis_maximum.z|float %}
    {% set z_park = params.Z|default(((z_max * 0.75) / 10)|int * 10)|float %}
    ##### end of definitions #####
    _CG28
    M104 S{extruder_temp}
    G90
    G0 Z{z_park} F{travel_speed}

#####################################################################
#   Retraction Helpers
#####################################################################

[gcode_macro _CONDITIONAL_UNRETRACT]
variable_needs_unretract: True
gcode:
    ##### get user parameters or use default #####
    {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
    {% set length = params.LENGTH|default(client.unretract)|default(1.0)|float %}
    ##### end of definitions #####
    {% if needs_unretract and printer[printer.toolhead.extruder].can_extrude %}
        _CLIENT_EXTRUDE LENGTH={length}
        SET_GCODE_VARIABLE MACRO=_KAMP_Settings VARIABLE=tip_distance VALUE=0
        SET_GCODE_VARIABLE MACRO=_CONDITIONAL_UNRETRACT VARIABLE=needs_unretract VALUE=False
    {% endif %}

[gcode_macro _CONDITIONAL_RETRACT]
gcode:
    ##### get user parameters or use default #####
    {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
    {% set length = params.LENGTH|default(client.retract)|default(1.0)|float %}
    ##### end of definitions #####
    {% if printer[printer.toolhead.extruder].can_extrude %}
        _CLIENT_RETRACT LENGTH={length}
        SET_GCODE_VARIABLE MACRO=_KAMP_Settings VARIABLE=tip_distance VALUE={length}
        SET_GCODE_VARIABLE MACRO=_CONDITIONAL_UNRETRACT VARIABLE=needs_unretract VALUE=True
    {% endif %}

#####################################################################
#   Public Filament Macros (Expected by Mainsail & KlipperScreen)
#####################################################################

[gcode_macro LOAD_FILAMENT]
description: Loads new filament into toolhead (uses printer.extruder.target)
variable_load_distance:  60
variable_purge_distance:  100
gcode:
    {% set min_temp = printer.configfile.settings['extruder'].min_extrude_temp|int + 5 %}
    {% set extruder_temp = [min_temp, printer.extruder.target]|max|int %}
    {% set speed = [300, params.SPEED|default(300)|int]|max|int %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity|int * 60 %}

    _FILAMENT_OPERATION_INIT
    _HEAT_AND_PARK TEMP={extruder_temp} PARK_MACRO=_TOOLHEAD_PARK_LOAD_UNLOAD

    M117 Loading Filament...
    M83                            ; set extruder to relative
    G92 E0
    _TOOLHEAD_PARK_LOAD_UNLOAD
    G1 E{load_distance} F{max_velocity} # fast-load
    {% if printer['gcode_macro AFC_BRUSH'] is defined %}
        AFC_BRUSH
    {% endif %}
    _TOOLHEAD_PARK_PURGE
    G1 E{purge_distance} F{speed} # purge
    {% if printer['gcode_macro AFC_BRUSH'] is defined %}
        AFC_BRUSH
    {% endif %}
    G92 E0

    M117 Load Complete!
    SET_GCODE_VARIABLE MACRO=_CONDITIONAL_UNRETRACT VARIABLE=needs_unretract VALUE=False
    _FILAMENT_OPERATION_CLEANUP

[gcode_macro UNLOAD_FILAMENT]
description: Unloads filament from toolhead (uses printer.extruder.target)
variable_unload_distance:  65
variable_purge_distance:  12.45
gcode:
    {% set min_temp = printer.configfile.settings['extruder'].min_extrude_temp|int + 5 %}
    {% set extruder_temp = [min_temp, printer.extruder.target]|max|int %}
    {% set speed = [300, params.SPEED|default(300)|int]|max|int %}
    {% set max_velocity = printer.configfile.settings['extruder'].max_extrude_only_velocity|int * 60 %}

    _FILAMENT_OPERATION_INIT
    _HEAT_AND_PARK TEMP={extruder_temp} PARK_MACRO=_TOOLHEAD_PARK_LOAD_UNLOAD

    {% if printer['gcode_macro AFC_CUT'] is defined %}
        AFC_CUT
        M400                           ; wait for buffer to clear
        M104 S{extruder_temp}
        _TOOLHEAD_PARK_LOAD_UNLOAD
        M109 S{extruder_temp}          ; set extruder temperature and wait until it reaches loading temperature
        M400                           ; wait for buffer to clear
    {% endif %}

    M117 Unloading Filament...
    M83                            ; set extruder to relative
    G92 E0
    M104 S{min_temp}
    {% if printer['gcode_macro AFC_CUT'] is not defined %}
        _TOOLHEAD_PARK_PURGE
        G1 E{purge_distance} F{speed} # purge
    {% endif %}
    {% if printer['gcode_macro AFC_BRUSH'] is defined %}
        AFC_BRUSH
    {% endif %}
    M106 S255
    _TOOLHEAD_PARK_LOAD_UNLOAD
    G1 E-{unload_distance} F{max_velocity} # quickly retract to eliminate stringing
    {% if printer['gcode_macro AFC_BRUSH'] is defined %}
        AFC_BRUSH
    {% endif %}
    G92 E0

    M117 Unload Complete!
    SET_GCODE_VARIABLE MACRO=_CONDITIONAL_UNRETRACT VARIABLE=needs_unretract VALUE=True
    _FILAMENT_OPERATION_CLEANUP

[gcode_macro PURGE_FILAMENT]
description: Purge filament in a safe location (uses printer.extruder.target)
variable_purge_distance:  100
gcode:
    {% set min_temp = printer.configfile.settings['extruder'].min_extrude_temp|int + 5 %}
    {% set extruder_temp = [min_temp, printer.extruder.target]|max|int %}
    {% set speed = params.SPEED|default(300)|int %}

    _FILAMENT_OPERATION_INIT
    _HEAT_AND_PARK TEMP={extruder_temp} PARK_MACRO=_TOOLHEAD_PARK_PURGE

    M117 Purging Filament...
    M83                            ; set extruder to relative
    G92 E0
    _TOOLHEAD_PARK_PURGE
    G1 E{purge_distance} F{speed} # purge
    {% if printer['gcode_macro AFC_BRUSH'] is defined %}
        AFC_BRUSH
    {% endif %}
    G92 E0

    M117 Purge Complete!
    SET_GCODE_VARIABLE MACRO=_CONDITIONAL_UNRETRACT VARIABLE=needs_unretract VALUE=False
    _FILAMENT_OPERATION_CLEANUP

# M600 Filament Change Macro (Reserved for Future Multi-Filament Systems)
# Commented out pending installation of BoxTurtle or similar multi-material system.
# When uncommented, this provides Marlin-style M600 filament change during prints.
# [gcode_macro M600]
# description: Filament change
# gcode:
#     {% set x_center = printer.toolhead.axis_maximum.x|float / 2.0 %}
#     {% set y_front = printer.toolhead.axis_minimum.y|float + 10 %}
#     PAUSE X={x_center} Y={y_front} Z_MIN=50
#     # Z_MIN will park the toolhead at a minimum of 50 mm above to bed to make it easier for you to swap filament.

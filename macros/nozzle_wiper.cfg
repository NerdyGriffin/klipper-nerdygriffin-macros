# Hardware-agnostic NOZZLE WIPER v2
# Part of klipper-nerdygriffin-macros
# Source: https://github.com/chirpy2605/voron/tree/main/V0/NozzleWiper
#
# A servo-actuated nozzle purge bucket and brush system for automated nozzle cleaning
#
# Features:
# - Servo-controlled deployment (extends for cleaning, retracts when not in use)
# - Integrated purge bucket and brush
# - Hot-to-cold cleaning capability (wipes while cooling to minimize oozing)
# - Randomized wipe patterns across brush depth for even wear
# - Configurable wipe count, speeds, and temperatures
# - Optional STATUS_* LED integration
# - KAMP tip_distance synchronization
#
# See docs/CONFIGURATION.md for complete setup and customization instructions.

[gcode_macro NW_TEST_CLEAN_NOZZLE]
description: Test macro to heat and clean nozzle (for calibration)
gcode:
    M104 S240
    G28
    M109 S240
    NW_CLEAN_NOZZLE

[gcode_macro NW_CLEAN_NOZZLE]
description: Main nozzle cleaning routine (deploy, purge, wipe, retract)
gcode:
    {% if printer['gcode_macro STATUS_CLEANING'] is defined %}
        STATUS_CLEANING
    {% endif %}

    {% if "xyz" in printer.toolhead.homed_axes %}
        SAVE_GCODE_STATE NAME=NW_CLEAN_NOZZLE
        G90
        NW_DEPLOY
        NW_PURGE
        NW_WIPE
        NW_RETRACT
        RESTORE_GCODE_STATE NAME=NW_CLEAN_NOZZLE
    {% else %}
        { action_raise_error("Home All Axis First") }
        M117 Home All Axis First
    {% endif %}

    {% if printer['gcode_macro STATUS_READY'] is defined %}
        STATUS_READY
    {% elif printer['gcode_macro RESET_STATUS'] is defined %}
        RESET_STATUS
    {% endif %}

[gcode_macro NW_BUCKET_POS]
description: Bucket/brush position variables (override in printer.cfg)
# See docs/CONFIGURATION.md for calibration instructions
variable_x: -1000  # Deliberately wrong - forces calibration
variable_y: -1000  # Deliberately wrong - forces calibration
variable_z: 50     # Safe default Z height
gcode:
    M118 bucket pos X:{printer["gcode_macro NW_BUCKET_POS"].x} Y:{printer["gcode_macro NW_BUCKET_POS"].y} Z:{printer["gcode_macro NW_BUCKET_POS"].z}

[gcode_macro NW_DEPLOY]
description: Deploy servo arm (extend for cleaning)
gcode:
    G90
    G0 Z{printer["gcode_macro NW_BUCKET_POS"].z} F6000
    SET_SERVO SERVO=wipeServo ANGLE=0
    M400
    G4 P500

[gcode_macro NW_RETRACT]
description: Retract servo arm (stow after cleaning)
gcode:
    SET_SERVO SERVO=wipeServo ANGLE=100
    M400
    G4 P500
    SET_SERVO SERVO=wipeServo WIDTH=0  # Turn off servo PWM
    G4 P500

[gcode_macro NW_WIPE]
description: Wipe nozzle on brush with hot-to-cold cleaning
# Hot-to-cold cleaning: wipes while cooling to minimize oozing
variable_enable_hotcold: True  # Set to False to disable cooling during wipe

# Wipe parameters
variable_wipe_qty_min: 4       # Minimum complete wipe cycles before checking temperature
variable_wipe_qty_max: 128     # Maximum wipe cycles (stops early if cooled to scrub_temp_min)
variable_prep_spd_xy: 30000    # Travel speed along X/Y in mm/min
variable_prep_spd_z: 3000      # Travel speed along Z in mm/min
variable_wipe_spd_xy: 30000    # Wiping speed in mm/min
variable_scrub_temp_min: 150   # Minimum nozzle temperature to continue scrubbing (°C)

# Brush geometry parameters (override in printer.cfg)
# Visual reference:
#                 brush_start (Y)
#                   _______
#                  |       |
#               ↑  |       |
#     brush_length |       | (X) brush_front
#               ↓  |       |
#                  |_______|
#               ← brush_depth →
variable_brush_start: 65       # Y position where brush begins
variable_brush_length: 45      # Length of brush in Y direction
variable_brush_front: 11       # X position of brush front edge
variable_brush_depth: 6        # Depth of brush in X direction
variable_brush_segments: 20    # Number of wipe segments (higher = smoother motion)

gcode:
    {% if printer['gcode_macro STATUS_CLEANING'] is defined %}
        STATUS_CLEANING
    {% endif %}

    # Calculate wipe parameters
    {% set brush_step = brush_length / brush_segments %}
    {% set brush_lanes = [brush_front, brush_front - brush_depth/3, brush_front - brush_depth/3*2, brush_front - brush_depth] %}

    G90
    G0 Z{printer["gcode_macro NW_BUCKET_POS"].z} F{prep_spd_z}
    G0 Y{brush_start - (brush_length / 2)} F{prep_spd_xy}
    G0 X{brush_front - (brush_depth / 2)}

    # Set temp to min scrub temp to allow nozzle to cool during scrubbing
    {% if enable_hotcold == True %}
        M104 S{scrub_temp_min}
    {% endif %}

    M106 S255  # Part cooling fan on for air circulation
    M400

    # Perform randomized wipe pattern
    G1 F{wipe_spd_xy}
    SET_GCODE_VARIABLE MACRO=_clean_nozzle_move VARIABLE=move VALUE=True
    {% for wipes in range(1, (wipe_qty_max + 1)) %}
        {% for segments in range(1, (brush_segments + 1)) %}
            _clean_nozzle_move X={brush_lanes[range(4)|random]} Y={brush_start - brush_step * segments}
        {% endfor %}
        {% for segments in range(1, (brush_segments + 1)) %}
            _clean_nozzle_move X={brush_lanes[range(4)|random]} Y={brush_start - brush_length + brush_step * segments}
        {% endfor %}
        {% if enable_hotcold == True and wipes > wipe_qty_min %}
            _clean_nozzle_cooldown_check
        {% endif %}
    {% endfor %}

    M400
    M106 S0  # Part cooling fan off

    # Clear from area
    M117 Cleaned!
    G0 Y{brush_start + 20} F{prep_spd_xy}
    G0 X60 F{prep_spd_xy}
    G0 Y60 F{prep_spd_xy}

    {% if printer['gcode_macro STATUS_READY'] is defined %}
        STATUS_READY
    {% elif printer['gcode_macro RESET_STATUS'] is defined %}
        RESET_STATUS
    {% endif %}

[gcode_macro NW_PURGE]
description: Purge filament into bucket before wiping
# Purge parameters
variable_purge_len: 5          # Amount of filament to purge (mm)
variable_purge_spd: 150        # Purge speed (mm/min)
variable_purge_temp_min: 240   # Minimum nozzle temperature for purge (°C)
variable_purge_ret: 2          # Retract after purge to prevent oozing (mm)
variable_ooze_dwell: 2         # Dwell time after retract (seconds)

gcode:
    G90
    G0 Z{printer["gcode_macro NW_BUCKET_POS"].z} F6000
    G0 Y{printer["gcode_macro NW_BUCKET_POS"].y + 40} F6000
    G0 X{printer["gcode_macro NW_BUCKET_POS"].x}
    G0 Y{printer["gcode_macro NW_BUCKET_POS"].y} F6000

    # Unretract if previously retracted (conditional helper from utility_macros.cfg)
    {% if printer['gcode_macro _CONDITIONAL_UNRETRACT'] is defined %}
        _CONDITIONAL_UNRETRACT
    {% endif %}

    {% if printer.extruder.temperature >= purge_temp_min %}
        M83  # Relative extrusion mode
        G1 E{purge_len} F{purge_spd}
        G1 E-{purge_ret} F{purge_spd * 5}
        G4 P{ooze_dwell * 1000}
        G92 E0  # Reset extruder position

        # Sync tip_distance with KAMP if available
        {% if printer['gcode_macro _KAMP_Settings'] is defined %}
            SET_GCODE_VARIABLE MACRO=_KAMP_Settings VARIABLE=tip_distance VALUE={purge_ret}
        {% endif %}
    {% endif %}

[gcode_macro _clean_nozzle_move]
description: Helper macro to conditionally execute wipe moves (controlled by hot-to-cold logic)
variable_move: True
gcode:
    {% if move == True %}
        {% set x = params.X %}
        {% set y = params.Y %}
        G1 X{x} Y{y}
    {% endif %}

[gcode_macro _clean_nozzle_cooldown_check]
description: Check if nozzle has cooled to target temp and stop wiping if reached
gcode:
    {% set extruder_temperature = printer[printer.toolhead.extruder].temperature %}
    {% set extruder_target = printer[printer.toolhead.extruder].target %}
    {% if extruder_temperature <= extruder_target + 1 %}
        SET_GCODE_VARIABLE MACRO=_clean_nozzle_move VARIABLE=move VALUE=False
    {% endif %}

[gcode_macro CLEAN_NOZZLE]
description: Wrapper macro for compatibility with other systems
gcode: NW_CLEAN_NOZZLE

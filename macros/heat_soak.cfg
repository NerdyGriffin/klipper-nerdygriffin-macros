# Hardware-agnostic HEAT_SOAK macro
# Part of klipper-nerdygriffin-macros
# - Auto-detects chamber temperature sensor
# - Optional panel LED animation gated by variable
# - Supports per-printer overrides via [gcode_macro HEAT_SOAK] variables in printer.cfg

[gcode_macro M141]
description: Emulate chamber heater using temperature_fan
gcode:
    {% set S = params.S|default(0)|float %}
    # SET_TEMPERATURE_FAN_TARGET temperature_fan="chamber" target={S}
    SET_DISPLAY_TEXT MSG="Requested Chamber: {S}C"

[gcode_macro M191]
description: Emulate chamber heater using HEAT_SOAK macro
gcode:
    {% set S = params.S|default(0)|float %}
    M141 {rawparams}
    {% if S|float == 0 %}
        # Do nothing
    {% else %}
        HEAT_SOAK CHAMBER={S} DURATION=0
    {% endif %}

[gcode_macro HEAT_SOAK]
description: Chamber preheat with passive heating and optional LED progress animation.
variable_max_chamber_temp: 60  # Max achievable via passive heating (stock heaters, no insulation)
variable_ext_assist_multiplier: 4  # Extruder assist temp = chamber_temp × multiplier (capped at 200°C)
variable_chamber_sensor_name: ""  # Explicit sensor name (empty = auto-detect: chamber > nitehawk-36)
variable_frame_rate: 12  # Default LED animation frame rate (Hz)
gcode:
    {% set target_bed = params.BED|default(printer.heater_bed.target)|int %}
    {% set target_extruder = params.EXTRUDER|default(printer.extruder.target)|int %}
    # Target chamber = max(requested, bed/2), capped at max_chamber_temp
    {% set target_chamber = [([(params.CHAMBER|default(20)|int), target_bed//2]|max), max_chamber_temp]|min %}
    # Extruder assist = chamber_temp × multiplier, capped at 200°C to avoid oozing
    {% set ext_assist_temp = [target_chamber * ext_assist_multiplier, 200]|min %}
    # Bed assist = chamber_temp × 4, capped at bed_max - 10°C for safety margin
    {% set bed_assist_temp = [target_chamber * 4, (printer.configfile.settings.heater_bed.max_temp - 10)]|min %}

    # Resolve chamber sensor (prefer explicit chamber_sensor_name, else auto-detect)
    {% set chamber_sensor = none %}
    {% if chamber_sensor_name and ("temperature_sensor " ~ chamber_sensor_name) in printer %}
        {% set chamber_sensor = "temperature_sensor " ~ chamber_sensor_name %}
    {% elif "temperature_sensor chamber" in printer %}
        {% set chamber_sensor = "temperature_sensor chamber" %}
    {% elif "temperature_sensor nitehawk-36" in printer %}
        {% set chamber_sensor = "temperature_sensor nitehawk-36" %}
    {% endif %}

    {% if not chamber_sensor %}
        {action_respond_info("HEAT_SOAK: No chamber sensor detected, skipping temperature wait")}
    {% endif %}

    _CG28

    # Enable assist heating only if chamber sensor exists and below target
    {% if chamber_sensor and (printer[chamber_sensor].temperature < target_chamber) %}
        M106 S255  # Part cooling fan for air circulation
        M104 S{ext_assist_temp}  # Extruder assist heating
        {% if target_chamber > 35 %}  # Only use bed assist for higher chamber temps
            M140 S{bed_assist_temp}
        {% endif %}
    {% endif %}

    G90
    G0 Z2   ; position probe/toolhead at 2mm for heat soak
    CENTER

    M400 ; wait for buffer to clear
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=0
    SET_DISPLAY_TEXT MSG="Preheating..."
    G4 P1000

    {% if chamber_sensor and (printer[chamber_sensor].temperature < target_chamber) %}
        STATUS_HEATING
        M117 Heatsoak: {target_chamber}C
        TEMPERATURE_WAIT SENSOR="{chamber_sensor}" MINIMUM={target_chamber}  # Wait for chamber to reach target
        G4 P1000
    {% endif %}

    M104 S{target_extruder}  # Reset extruder to final target temp
    M190 S{target_bed}  # Wait for bed to reach final target temp

    # === Soak Duration Countdown with LED Progress Animation ===
    # Get DURATION in minutes and convert to milliseconds
    {% set DURATION_MS = ( params.DURATION|default(5)|float * 60000 )|int %}
    # Calculate the number of times to refresh the LEDs
    {% set refresh_delay = 1000 / frame_rate %}
    {% set REFRESH_COUNT = ( DURATION_MS / refresh_delay )|int %}
    # For each refresh of the LEDs:
    {% for refresh_index in range(0, REFRESH_COUNT) %}
        # Calculate the total milliseconds until the preheat timer is complete
        {% set MILLISECONDS_REMAINING = refresh_delay * ( REFRESH_COUNT - refresh_index ) %}
        # Convert the total time remaining into minutes and seconds
        {% set MINUTES_REMAINING = ( MILLISECONDS_REMAINING / 60000 ) %}
        {% set SECONDS_REMAINING = ( MILLISECONDS_REMAINING / 1000 ) %}
        # Format the minutes and seconds for a clock-style display
        {% set MINUTES_FORMATTED = MINUTES_REMAINING|int %}
        {% set SECONDS_FORMATTED = ( SECONDS_REMAINING - ( 60 * ( SECONDS_REMAINING / 60 )|int ) )|int %}
        # Display the current time remaining
        SET_DISPLAY_TEXT MSG="Heatsoak: {"%02d:%02d"|format(MINUTES_FORMATTED, SECONDS_FORMATTED)}"

        # Color fade scaling per frame (0.0→1.0)
        {% set COLOR_SCALE = (refresh_index % (REFRESH_COUNT / 10)) / (REFRESH_COUNT / 10) %}

        # Chamber LEDs: iterate map-driven devices
        {% set L = printer['gcode_macro _LED_VARS'] %}
        {% for name, idx in L.chamber_map.items() %}
            {% set idx_str = (idx|string).strip() %}
            {% set has_device = ("neopixel " ~ name) in printer %}
            {% if has_device %}
                {% set dev_key = "neopixel " ~ name %}
                {% set dev_cfg = printer.configfile.settings[dev_key] if dev_key in printer.configfile.settings else none %}
                {% set hw_len = dev_cfg.chain_count if dev_cfg is not none and dev_cfg.chain_count is defined else 1 %}
                {% set indices = idx_str.split(',') if idx_str else range(1, hw_len|int + 1) %}
                {% set device_len = (indices|length) %}
                {% set progress_index_device = (device_len * refresh_index / refresh_count)|int + 1 %}
                {% for led_index in indices %}
                    {% if led_index < progress_index_device %}
                        SET_LED LED={name} INDEX={led_index|int} RED=0.0 GREEN=0.4 BLUE=0.0 SYNC=0
                    {% elif led_index == progress_index_device %}
                        SET_LED LED={name} INDEX={led_index|int} RED={0.4*(1-COLOR_SCALE)} GREEN={0.4*COLOR_SCALE} BLUE=0.0 SYNC=0
                    {% else %}
                        SET_LED LED={name} INDEX={led_index|int} RED=0.4 GREEN=0.0 BLUE=0.0 SYNC=0
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endfor %}

        # Logo LEDs: update via logo_map (color fade), indices honored if provided
        {% for name, idx in L.logo_map.items() %}
            {% set idx_str = (idx|string).strip() %}
            {% set indices = idx_str.split(',') if idx_str else [''] %}
            {% if ("neopixel " ~ name) in printer %}
                {% for i in indices %}
                    {% if i %}
                        SET_LED LED={name} INDEX={i|int} RED={0.4*(1-COLOR_SCALE)} GREEN={0.4*COLOR_SCALE} BLUE=0.0 WHITE=0.0 SYNC=0
                    {% else %}
                        SET_LED LED={name} RED={0.4*(1-COLOR_SCALE)} GREEN={0.4*COLOR_SCALE} BLUE=0.0 WHITE=0.0 SYNC=0
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endfor %}

        G4 P{refresh_delay}
    {% endfor %}

    M117 Heatsoak Complete

    RESET_STATUS
